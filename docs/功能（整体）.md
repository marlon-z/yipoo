

# 1. 项目目标与边界

* 目标：做一款**在线 Markdown 编辑器**，写作顺手、样式现代；提供**轻量 Git 管理**但不增加学习成本。
* 边界（非目标）：不做复杂 Git 客户端（PR/图谱/三方合并界面），不做公众号等富媒体适配。

---

# 2. 技术基线（简单说）

* 前端：Next.js 15.x（App Router）+ React + TypeScript + Tailwind。
* 编辑：**Milkdown**（最新版开源项目），
* 解析/TOC/预览：**Web Worker**内跑 unified（remark/rehype）+ Shiki/HLJS + KaTeX/Mermaid（按需）。
* Git：**isomorphic-git**。
* 存储：**IndexedDB**（恢复层）+ **DW 文件**（检查点，OPFS/FS Access/后端）+ 本地存储（UI 偏好）。

> 规则：**使用稳定版本**；能在 Worker 跑的都放 Worker。

---

# 3. 页面结构与职责

```
Topbar
Left Sidebar:  文件（DW） | Git（RW）
Center:        模式切换条 + 编辑器（WYSIWYG/源码/分屏） + 右侧内嵌目录（TOC）
Right Sidebar: 外观/渲染/导出/协作
Status Bar
```

### 3.1 Topbar（顶部）

* 菜单：新建/打开/保存、查找、视图。
* 中部：当前文件名；`●` 表示“还有内容未写入 DW”（不影响恢复层）。
* 右侧：同步（Fetch/Pull/Push + 分支/↑↓）、导出（MD/HTML/PDF/Docx）、协作、设置。
* 护栏：导出/离页前**强制保存**；合并/变基中仅允许 Fetch。

### 3.2 左侧 · 文件区（DW）

* 职责：**唯一的内容编辑来源**（草稿地）。
* 操作：新建/重命名/删除（默认软删）/移动/上传；**移入版本库…**（DW→RW）。
* 冲突：默认**保留两份**（自动改名），可切“覆盖/跳过”。
* 合并/变基中：禁用“移入”。

### 3.3 左侧 · Git 区（RW）

* 职责：**版本状态管理**（不直接编辑内容，默认不新建/改文件）。
* 视图：分支/远端状态；改动列表（stage/unstage/restore/diff）；提交区；同步按钮。
* 跨区：**移出到文件区…**（工作树→DW）、**从历史移出…**（提交→DW）。
* 护栏：未暂存不可提交；合并/变基中限制工作树相关“移出”。

### 3.4 中央编辑区

* 模式：所见即所得（Milkdown）｜源码（CM6）｜分屏（左编辑、右只读预览）。
* 目录（TOC，内嵌右侧）：H1–H6、搜索、折叠、当前标题高亮；点击跳转编辑位置；分屏同步预览。
* 粘贴：保留基本样式；图片可粘贴/拖拽，存 DW，用相对路径。

### 3.5 右侧栏（设置/渲染/导出/协作）

* 外观：暗/浅、字体/字号/行距、代码主题（即时生效）。
* 渲染：高亮/公式/Mermaid/图片懒加载/链接新开（切换触发增量重渲）。
* 导出：MD/HTML/PDF/Docx（导出前强制保存）。
* 协作（可选）：开/关、房间号、在线成员。

### 3.6 Status Bar（底部）

* 显示：文件状态（dirty/readonly/编码/EOL）、分支/↑↓/合并中、协作人数、解析耗时/FPS、行:列、字数、任务/错误。
* 点击直达：Git 面板、统计卡、日志/任务抽屉。

---

# 4. 全局保存机制（所有板块）

> 目标：刷新/崩溃**不丢稿**；UI 状态能记住但**清缓存可丢**无妨。

* **内容（强耐久）**

  * **恢复层（IndexedDB）**：编辑增量**200–300ms**合批写入；最大丢失窗 ≤ **2s**。
  * **DW 检查点**：空闲 **5s** / 连续编辑 **2min** / 新增 **1000 字** 任一满足→**原子写**到 DW。
  * **强制保存**：离页/刷新/导出/移入/移出/切模式前：先写恢复层，再尝试 DW（DW 失败也能恢复）。

* **界面（可丢弃）**

  * 布局/展开/筛选/主题/目录设置：**50–150ms** 内写 session/local/轻量 IDB。
  * 清缓存丢失无妨；文档内容不受影响。

* **恢复流程**

  * 打开文档：若恢复层比 DW 新 → 顶部横幅“发现未保存内容（时间）”，**一键恢复/查看差异/丢弃**；恢复后立即写入 DW 基线。

---

# 5. 关键流程（开发按此实现）

### 5.1 写作与保存

1. 打开 DW 文件 → 编辑区输入。
2. 2s 内增量落恢复层；满足阈值落 DW 检查点。
3. 刷新/崩溃重开 → 横幅提示 → 一键恢复。

### 5.2 DW → RW（移入版本库…）

1. 文件区选择 n 个条目 → 点击“移入版本库…”。
2. 显示策略（保留两份/覆盖/跳过）+ 进度；RW 出现改动（未提交）。
3. Toast“已移入（未提交）”并给“去提交”按钮。

### 5.3 提交并推送

1. Git 区暂存需要的文件 → 填提交说明 → 提交。
2. Push；需要拉取时 Pull/Fetch。

### 5.4 远端改动拉回与冲突处理

1. Git 区 Pull/Fetch；若有冲突，列表标记。
2. 对冲突文件 **“移出到文件区…”** → 在 DW 编辑解决 → 再“移入版本库…” → 暂存/提交/推送。

### 5.5 从历史取一份（不影响当前）

1. Git 区 **“从历史移出…”** → 选提交与文件 → 复制到 DW。
2. 在 DW 查看/编辑，互不影响当前工作树。

### 5.6 导出

1. Topbar 点“导出” → 选格式与选项。
2. 系统先保存 → 生成文件。

---

# 6. 护栏（统一规则）

* **DW/RW 不自动同步**；跨区必须用“移入/移出/从历史移出…”。
* **合并/变基中**：禁用“移入”（DW→RW 工作树）与“从工作树移出”；允许“从历史移出”。
* **同名冲突**：默认**保留两份**（自动改名），可改“覆盖/跳过”；批量操作有失败清单。
* **未暂存禁止提交**；只读文件禁止改名/删除。
* **安全**：默认拦截脚本；需要受信内容由右侧栏显式开启。

---

# 7. 性能与体验目标（量化）

* 输入→预览更新 **< 120ms**
* 模式切换 **< 150ms**（保持光标与滚动）
* 目录 TOC 生成 **< 50ms / 1000 标题**（虚拟列表）
* 最大编辑丢失窗 **≤ 2s**（崩溃/刷新）

---

# 8. 埋点与日志（最少够用）

* 关键事件：移入/移出/提交/推送/导出 成功与失败（含原因）。
* 关键指标：输入→预览延迟、解析耗时、导出耗时、Git 操作耗时、恢复触发次数。
* 错误日志：可复制文本，含步骤与文件清单。

---

# 9. 测试与验收（DoD）

* [ ] 刷新/崩溃后出现**恢复横幅**，一键恢复成功（丢失 ≤2s）。
* [ ] 文件区 **移入** → Git 区出现改动（**未自动提交**）。
* [ ] Git 区 **移出** / **从历史移出** → 文件区出现副本（RW 状态不变）。
* [ ] 合并/变基中的禁用规则生效且提示明确。
* [ ] TOC 点击 **<150ms** 定位成功；分屏滚动同步顺滑。
* [ ] 导出前强制保存；导出成功，超大文档有耗时提示。
* [ ] 未暂存时无法提交并有提示。
* [ ] 无隐式跨区同步；默认同名“保留两份”。

---

# 10. 实施顺序（里程碑）

1. **M1：编辑核心**

   * 三模式、TOC、解析 Worker、全局保存（恢复层+DW 检查点）、状态栏基础。
2. **M2：文件/Git**

   * 文件区 CRUD + “移入”；Git 区改动列表/提交/同步 + “移出/从历史移出”。
3. **M3：导出/协作/性能**

   * 导出四格式、协作基础、性能打磨、A11y 与埋点。
4. **M4：打磨与风险项**

   * 冲突处理细节、失败清单、国际化与文案完善。

---



---

> **一句话总结**：
> 用户**只在文件区写**，需要上版本库就**手动移入**，再在 Git 区**提交/推送**；系统**随写随存**，刷新/崩溃也能**一键恢复**；所有跨区动作都**显式**，不搞暗箱操作。开发按上面流程与护栏实现，即可稳定上线。
