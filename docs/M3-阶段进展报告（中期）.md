# M3 阶段进展报告（中期）

> 范围：导出 / 协作 / 性能与可见性。本报告用于对齐当前完成度与后续计划，待全部验收项达成后将产出《M3 完结报告》。

## 一、阶段目标回顾（摘自 docs/流程的.md）
- 导出四格式：Markdown / HTML / PDF / Docx（导出前保存）
- 协作基础：开/关协作、在线成员展示、断网重连、只读禁编辑
- 性能与可见性：输入→预览 <120ms；模式切换 <150ms；TOC 生成 <50ms/1000 标题；状态/任务/错误可见

## 二、当前完成度
- [x] 导出 - Markdown：保存前置，下载 `.md`
- [x] 导出 - HTML（基础版）：内置 `markdownToHtml` 渲染并下载 `.html`
- [x] 可见性 - 任务/错误：新增 `lib/task-bus`，底部状态栏显示“进行中/错误”汇总
- [x] 导出动作接入任务总线：统一上报进度/失败
- [ ] 导出 - PDF：当前为占位（将 HTML 以 `.pdf` 扩展名下载），需接真实渲染
- [ ] 导出 - Docx：当前为占位（直接以 `.docx` 扩展名下载内容），需接 `docx` 生成
- [ ] 协作基础：未实现
- [ ] 性能目标与指标：未落地（需 unified Worker 管线与指标上报）
- [ ] 导出参数面板：与 Topbar 导出菜单未打通

## 三、差距与原因
- PDF/DOCX 需选择与落地可靠库（或服务端渲染方案），当前仅有占位实现。
- 协作涉及会话/房间与只读态，需独立通信层（可先占位本地模拟）。
- 性能指标依赖 unified Worker 管线与采样上报，目前仅有占位接口。

## 四、近期计划（1–2 天）
1) 导出能力完善（优先）
   - HTML：接入 unified + rehype + 样式注入，支持导出选项（高亮/公式/Mermaid/图片内联）。
   - PDF：使用 `pdf-lib`（前端方案）或服务端 Puppeteer（如加 edge 函数）生成；先落地 `pdf-lib` 版本。
   - Docx：接入 `docx` 库生成基本段落/标题/代码块；图片按相对路径嵌入。
2) 可见性
   - 任务总线对接导出进度更细粒度（0/25/50/75/100）。
   - 错误详情抽屉（点击状态栏“错误”跳转查看）。
3) 性能与解析
   - 建立 unified Worker 骨架（remark/rehype + 选项），预留增量渲染接口；记录解析耗时并上报到任务总线或日志。
4) 协作（占位）
   - UI：开/关协作、在线成员假数据；只读态禁编辑。

## 五、风险与应对
- PDF 渲染兼容性：`pdf-lib` 纯前端可能样式有限 → 先实现纯文本/简单样式，必要时引入服务端渲染。
- Docx 语义映射复杂：优先覆盖标题/段落/列表/代码块，逐步补充。
- Worker 跨线程开销：采用批量/节流策略；大文档降级提示。

## 六、需要的决策/输入
- 是否接受前端版 PDF（样式有限）作为第一阶段交付，服务端渲染延后？
- Docx 是否只需基础样式（首版），复杂表格/脚注延后？

## 七、里程碑对齐
- 达成上述“导出（HTML/PDF/Docx）基础可用 + 可见性 + 协作占位 + 性能管线骨架”后，即可进入 M3 收尾并产出《M3 完结报告》。

—
作者：研发
日期：$(date +%Y-%m-%d)
