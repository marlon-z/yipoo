# M3 阶段进展报告（中期）

> 范围：导出 / 协作 / 性能与可见性。本报告用于对齐当前完成度与后续计划，待全部验收项达成后将产出《M3 完结报告》。

## 一、阶段目标回顾（摘自 `docs/流程的.md`）
- 导出四格式：Markdown / HTML / PDF / Docx（导出前保存）
- 协作基础：开/关协作、在线成员展示、断网重连、只读禁编辑
- 性能与可见性：输入→预览 <120ms；模式切换 <150ms；TOC 生成 <50ms/1000 标题；状态/任务/错误可见

## 二、当前完成度（截至 2025-08-28）
- [x] 导出 - Markdown：保存前置，下载 `.md`
- [x] 导出 - HTML：统一 `unified` 渲染（remark→rehype），支持 KaTeX/代码高亮、标题锚点与自动链接
- [x] 导出 - PDF：基于 `pdf-lib` 生成，支持页码（导出选项联动）
- [x] 导出 - Docx：基于 `docx` 生成，覆盖标题/段落/代码块等基础要素
- [x] 导出参数面板 <→ Topbar 导出菜单：通路打通，统一任务上报
- [x] 可见性 - 任务/错误：`lib/task-bus` 汇总进行中/错误；错误详情抽屛联动状态栏
- [x] 解析/渲染 Worker 化：remark→rehype Worker；TOC 使用 Worker
- [x] 指标初步：解析耗时已上报并在底部显示
- [ ] 协作基础：未实现（开关/在线成员/断网重连/只读）
- [ ] 性能目标验收：输入→预览/模式切换/TOC 目标值尚未闭环

## 三、差距与原因
- 协作尚未落地，需独立通信层（可先本地模拟）。
- 指标闭环未完成，需在编辑输入、Worker 解析与导出链路补齐埋点并校验阈值。
- 导出质量仍需打磨（PDF 字体/分页，Docx 图片/表格占位与样式）。

## 四、近期计划（1–2 天）
1) 性能与指标闭环（优先）
   - `metrics-bus` 统一上报：输入→预览延迟、解析耗时、导出耗时；进度细粒度 0/25/50/75/100。
   - 阈值校验与可视化：超过阈值给出提示与降级策略（大文档）。
2) 协作基础（占位）
   - 协作开关与只读态；在线成员展示（本地假数据）；断网重连提示。
3) 导出质量收尾
   - PDF：字体/分页稳定性与跨浏览器验证；失败回退策略。
   - Docx：完善图片/表格占位；导出选项持久化与非法组合校验。
4) 文档与验收
   - 产出《M3 完结报告》，并在 `docs/里程碑-开发记录.md` 勾选已达成项。

## 五、风险与应对
- PDF 渲染兼容性：`pdf-lib` 纯前端样式有限 → 先保障可用性，必要时引入服务端渲染回退。
- Docx 语义映射复杂：优先覆盖标题/段落/列表/代码块，逐步补齐。
- Worker 跨线程开销：批量/节流；大文档提示与降级。

## 六、需要的决策/输入
- 是否接受“前端版 PDF”为第一阶段交付，服务端渲染延后？
- Docx 是否以“基础样式”为首版目标，复杂表格/脚注延后？

## 七、里程碑对齐
- 达成“导出（HTML/PDF/Docx）可用 + 可见性完善 + 协作占位 + 指标闭环”后，进入 M3 收尾并产出《M3 完结报告》。

—
作者：研发
日期：2025-08-28
