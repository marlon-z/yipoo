# Milkdown 文件上传功能指南

## 概述

文件上传功能是 Milkdown 编辑器的重要增强功能，允许用户通过拖拽或点击按钮的方式上传文件到编辑器中。本指南将详细介绍该功能的使用方法、配置选项和技术实现。

## 功能特性

### 🎯 核心功能

- **多种上传方式**: 支持点击按钮选择文件和拖拽上传
- **文件类型过滤**: 支持图片、PDF、文本文件等多种格式
- **实时进度显示**: 上传过程中显示进度条和文件名
- **自动格式转换**: 根据文件类型自动生成相应的 Markdown 语法
- **本地存储**: 文件保存到浏览器本地存储，无需外部服务器

### 🛠️ 支持的文件类型

- **图片文件**: JPG, PNG, GIF, WebP, SVG
- **文档文件**: PDF, TXT, Markdown
- **文件大小限制**: 最大 10MB

## 使用方法

### 1. 点击上传

1. 在编辑器工具栏点击「上传文件」按钮
2. 在弹出的文件选择器中选择要上传的文件
3. 文件会自动处理并插入到编辑器中

### 2. 拖拽上传

1. 直接将文件拖拽到编辑器区域
2. 释放鼠标即可开始上传
3. 支持同时拖拽多个文件

### 3. 上传进度

- 上传过程中会显示进度条
- 显示当前上传的文件名和进度百分比
- 完成后自动隐藏进度指示器

## 功能配置

### 上传处理器配置

```typescript
// 在 lib/upload-handler.ts 中配置
const uploadHandler = new UploadHandler({
  maxFileSize: 10 * 1024 * 1024, // 10MB
  allowedTypes: [
    'image/jpeg',
    'image/png', 
    'image/gif',
    'image/webp',
    'image/svg+xml',
    'application/pdf',
    'text/plain',
    'text/markdown'
  ],
  uploadPath: 'uploads'
});
```

### 编辑器集成

```typescript
// 在 EnhancedMilkdownEditor.tsx 中的实现
const handleFileUpload = async (files: FileList) => {
  const results = await milkdownUploader(files);
  // 处理上传结果...
};
```

## 技术实现

### 文件处理流程

1. **文件验证**: 检查文件大小和类型
2. **格式转换**: 将文件转换为 Base64 或本地 URL
3. **Markdown 生成**: 根据文件类型生成相应的 Markdown 语法
4. **内容插入**: 将生成的 Markdown 插入到编辑器中

### 存储机制

- **图片文件**: 转换为 Base64 Data URL，直接嵌入 Markdown
- **其他文件**: 保存到 localStorage，生成本地访问 URL
- **清理机制**: 定期清理过期的本地存储文件

### 生成的 Markdown 格式

```markdown
<!-- 图片文件 -->
![文件名](data:image/jpeg;base64,...)

<!-- 其他文件 -->
[文件名 (文件大小)](local://upload_timestamp_random.ext)
```

## 使用示例

### 基本用法

1. **上传图片**:
   - 拖拽图片文件到编辑器
   - 自动生成: `![image.jpg](data:image/jpeg;base64,...)`

2. **上传文档**:
   - 点击上传按钮选择 PDF 文件
   - 自动生成: `[document.pdf (2.5MB)](local://upload_...)`

### 批量上传

- 同时选择多个文件进行上传
- 系统会逐个处理并插入到编辑器中
- 如果某个文件上传失败，不会影响其他文件

## 错误处理

### 常见错误及解决方案

1. **文件大小超限**
   - 错误信息: "文件大小不能超过 10MB"
   - 解决方案: 压缩文件或选择较小的文件

2. **不支持的文件类型**
   - 错误信息: "不支持的文件类型"
   - 解决方案: 选择支持的文件格式

3. **上传失败**
   - 错误信息: "文件上传失败"
   - 解决方案: 检查文件是否损坏，重试上传

## 注意事项

### 💡 最佳实践

1. **文件大小**: 建议上传文件不超过 5MB，以确保良好的性能
2. **存储清理**: 定期清理本地存储中的上传文件
3. **格式选择**: 优先使用 WebP 格式图片，文件更小
4. **批量操作**: 避免同时上传过多大文件

### ⚠️ 限制说明

1. **本地存储限制**: 浏览器 localStorage 有大小限制（通常 5-10MB）
2. **文件持久性**: 清除浏览器数据会丢失已上传的文件
3. **跨设备同步**: 本地上传的文件无法在其他设备上访问

## 扩展功能

### 未来计划

- [ ] 云存储集成（阿里云 OSS、腾讯云 COS）
- [ ] 图片自动压缩
- [ ] 文件预览功能
- [ ] 上传历史记录
- [ ] 文件管理界面

### 自定义扩展

可以通过修改 `upload-handler.ts` 来扩展功能：

```typescript
// 添加新的文件类型支持
allowedTypes: [...defaultTypes, 'application/zip']

// 自定义文件处理逻辑
async handleUpload(file: File): Promise<UploadResult> {
  // 自定义处理逻辑
}
```

## 问题反馈

如果在使用过程中遇到问题，请：

1. 检查浏览器控制台是否有错误信息
2. 确认文件格式和大小是否符合要求
3. 尝试刷新页面重新上传
4. 如问题持续存在，请提交反馈 