# 开发流程（与现有 UI 设计对齐）

> 状态：UI 框架已搭建，功能多为占位/Stub。目标：以“UI 先行、能力后置”的方式，分里程碑把 UI 驱动为可用系统；严格遵循 docs 各模块边界与护栏（DW/RW 解耦、无隐式同步、不做回退机制）。

## 1. 当前 UI 架构快照（代码对应）
- 布局骨架（App Router）
  - `app/page.tsx` 汇总全局布局状态：
    - `sidebarMode`: `files | git`
    - `editorMode`: `wysiwyg | source | split`
    - `isRightSidebarOpen`: 右侧栏开关
    - `isDarkMode`: 主题
- 顶部栏 TopBar：`components/layout/TopBar.tsx`
  - 左：文件/编辑/视图菜单（占位）
  - 中：文件名 + 未写入点 `●`
  - 右：同步/导出/协作（占位）、主题切换、右侧栏开关、设置（占位）
- 左侧栏 LeftSidebar：`components/layout/LeftSidebar.tsx`
  - 页签：`文件` → `FileExplorer`（占位），`Git` → `GitPanel`（占位）
- 中央编辑区 MainEditor：`components/layout/MainEditor.tsx`
  - 模式切换条：所见/源码/分屏
  - 编辑器：`UnifiedEditor`（Milkdown 单实例，三模式切换）
  - 内嵌 TOC：`components/features/TableOfContents.tsx`（基于 `editorState.content` 实时解析）
  - 全局上下文：`contexts/EditorContext.tsx`（内容、脏标、自动保存、保存 API）
- 右侧栏 RightSidebar：`components/layout/RightSidebar.tsx`
  - 页签：渲染（`RenderSettings`）、导出（`ExportPanel`）、协作（`CollabPanel`）、设置（占位）
- 底部状态栏：`components/layout/BottomStatusBar.tsx`（状态占位）
- TOC 解析：`lib/toc-parser.ts`（`extractHeadings`/`buildTOCTree`/`generateId` 已导出）

## 2. 里程碑（按现 UI 落地）
- M1 编辑核心可用
  - Milkdown 单实例三模式（已接入）：完善源码模式为官方 Source View；分屏滚动更精确；TOC 点击 <150ms 定位；编辑→恢复→DW 检查点策略落地；页面离开/导出等强制保存。
- M2 文件与 Git（DW/RW 解耦）
  - 文件区 CRUD + “移入版本库…”；Git 改动列表/暂存/提交/同步 + “移出/从历史移出”；统一禁用与冲突策略。
- M3 导出/协作/性能
  - 四格式导出（保存前置）；协作基础；预览/渲染性能；状态与错误可见化。
- M4 打磨与风险
  - 冲突细节、失败清单、国际化、A11y、埋点与指标。

## 3. 模块推进计划（按组件）
### 3.1 中央编辑区（MainEditor/UnifiedEditor/EditorContext/TOC）
- 数据流
  - `EditorContext` 统一管理 `content/isDirty/lastSaved` 与 `saveContent()`，暴露 `updateContent()`。
  - 模式切换：切换前尝试保存；保留滚动（光标进阶）。
- 所见（WYSIWYG）
  - 使用 Milkdown 常规 preset（commonmark/gfm/history/listener）。
- 源码（Source）
  - 现为简化文本区；替换为 Milkdown 官方 Source View（内部 CM6），避免第二套编辑器。
- 分屏（Split）
  - 左编辑、右只读预览；滚动同步比例 → 标题锚点级同步（进阶）。
- TOC
  - 已用 `editorState.content` 实时解析；点击派发 `toc-jump`，`UnifiedEditor` 定位到对应标题（`generateId` 保证锚点稳定）。
- 保存与恢复
  - 自动保存：输入 200–300ms 合批入 IndexedDB（恢复层）；阈值（空闲 5s / 连续 2min / +1000 字）写入 DW 检查点。
  - 强制保存：导出/移入/移出/离页/切模式前先落恢复层再写 DW。
  - 恢复横幅：DW 与恢复层差异提示并可一键恢复。

交付步骤（M1 内）：
1) 接入 Milkdown Source View；
2) 解析/预览 Worker 管线骨架（unified + 选项）；
3) IndexedDB 恢复层与 DW 检查点实现；
4) 离页/导出前保存；
5) TOC 滚动/点击体验与性能验证。

### 3.2 左侧栏（FileExplorer/GitPanel）
- 文件区（DW）
  - CRUD、上传、双击打开；“移入版本库…”（按钮+右键）。
  - 冲突默认保留两份；禁用条件（合并/变基）。
- Git 区（RW）
  - 改动列表（stage/unstage/restore/diff）；提交；同步（Fetch/Pull/Push，合并/变基中仅 Fetch）。
  - “移出到文件区…”、“从历史移出…”。

交付步骤（M2 内）：
1) isomorphic-git 接入（仓库初始化/打开/工作树扫描）；
2) 改动与暂存模型；
3) 提交与远端同步；
4) 移入/移出/历史移出；
5) 合并/变基禁用与提示。

### 3.3 顶部栏 / 右侧栏 / 状态栏
- 顶部栏（TopBar）
  - 同步/导出/协作/设置为入口；导出前先保存；与状态栏联动显示进度与错误。
- 右侧栏（RenderSettings/ExportPanel/CollabPanel）
  - 渲染开关即时生效（预览侧增量重渲）；导出参数；协作开关与状态。
- 状态栏（BottomStatusBar）
  - 展示 dirty/readonly/行:列/字数/分支/↑↓/任务/错误；点击跳转相关面板。

交付步骤：
- M1：主题/渲染开关即时生效（本地存储偏好）；状态栏显示保存状态与字数。
- M3：导出接入四格式；进度/错误流；协作入口与在线成员。

## 4. 验收（与 UI 一致）
- 中央编辑区默认 Milkdown 打开；三模式可切；分屏滚动同步；TOC 点击 <150ms 定位；代码块（CM6）正常。
- 保存策略按阈值落 DW；导出/离页前强制保存；刷新/崩溃后可恢复。
- 文件区/ Git 区严格 DW/RW 解耦；移入/移出/历史移出路径清晰；无隐式同步；未暂存不可提交；合并/变基限权。
- 导出四格式；状态栏可见进度与错误；右侧栏渲染开关即时生效。

## 5. 风险与护栏（保留）
- 不做回退机制；DW/RW 不自动同步；同名默认保留两份（可切覆盖/跳过）。
- 合并/变基进行中限制敏感操作；只读文件不改名/删除。
- 默认拦截脚本；受信内容需显式开启。

## 6. 工程约定
- 组件边界清晰；高内聚；避免深嵌套。
- 状态：内容走 `EditorContext`；偏好走 local/session/轻量 IDB。
- Worker 优先：解析/预览上 Worker；主线程保持流畅。
- 提交语义化（feat/fix/chore/docs），聚焦“为什么”。

---

附：关键代码锚点
- `components/layout/MainEditor.tsx`（模式切换/保存状态/TOC 容器）
- `components/features/UnifiedEditor.tsx`（Milkdown 单实例 + 分屏预览 + TOC 跳转）
- `components/features/TableOfContents.tsx`（解析大纲/点击跳转）
- `contexts/EditorContext.tsx`（内容/脏标/自动保存/保存 API）
- `lib/toc-parser.ts`（标题解析与稳定锚点）
- `components/layout/TopBar.tsx` / `LeftSidebar.tsx` / `RightSidebar.tsx` / `BottomStatusBar.tsx`
