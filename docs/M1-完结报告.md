# M1 完结报告（编辑核心）

## 目标达成情况
- [x] 中央编辑区三模式骨架（所见/源码/分屏）
- [x] EditorProvider 提升为全局：内容/脏标/自动保存/离页保存
- [x] 自动保存策略：2s 恢复层（IDB 占位）+ 5s DW 检查点（占位）
- [x] 导出：TopBar 按钮 → 先保存 → 下载 `.md`
- [x] TOC：实时解析当前内容（占位解析），点击跳转入口已预留
- [x] 底部状态栏：显示字数与“已保存/未保存”

## 实现要点
- `contexts/EditorContext.tsx`：统一编辑状态、自动保存、离页保存、模式状态
- `hooks/use-file-system.ts`：恢复层/DW 占位实现与下载工具
- `components/layout/TopBar.tsx`：导出前保存，下载 `.md`
- `components/layout/BottomStatusBar.tsx`：字数与保存状态
- `components/features/TableOfContents.tsx`：从上下文实时解析大纲（占位），可扩展为 Worker 解析
- `lib/markdown.ts`：轻量解析/统计工具（占位），后续替换为 unified + Worker

## 验收结果（UI 阶段）
- 切换模式保持 UI 正常；自动保存与离页保存均触发；导出可得到最新 `.md` 内容
- TOC 可随内容更新；状态栏呈现保存状态与字数
- 未引入 Git 行为；DW/RW 解耦保持

## 遗留与下一步（进入 M2 前）
- 将源码模式替换为 Milkdown 官方 Source View（内部 CM6），保证单一编辑器栈
- 将解析/预览迁移到 Web Worker（unified）并与右侧栏渲染开关联动
- 接入真正的 IndexedDB/OPFS/FS Access 替代占位；实现 DW 检查点阈值策略（2min/1000字）

## 变更清单
- 新增：`contexts/EditorContext.tsx`、`hooks/use-file-system.ts`、`lib/markdown.ts`
- 更新：`app/page.tsx`（挂载 Provider）、`TopBar`（导出）、`BottomStatusBar`（状态/统计）、`TableOfContents`（实时大纲）

> 以上为 UI 阶段 M1 的达成，按《docs/流程的.md》下一步推进 M2（文件/Git）。
